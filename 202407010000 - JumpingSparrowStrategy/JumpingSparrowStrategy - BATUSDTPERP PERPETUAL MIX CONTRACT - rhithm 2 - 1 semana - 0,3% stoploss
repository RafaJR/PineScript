//@version=4
strategy(title="Jumping sparrow",
         shorttitle="Estrategia de medias m贸viles", overlay = true, pyramiding = 0, 
         calc_on_order_fills = false, commission_type =  strategy.commission.percent, 
         commission_value = 0, default_qty_type = strategy.percent_of_equity, default_qty_value = 100, 
         initial_capital=100, currency=currency.EUR)

rhithm = 2
rhithmBis = 2
stopLossPercent = input(100, title="Porcentaje del Stop Loss (%)")

// Definir las medias m贸viles
preciosAltos = sma(high, rhithm)
preciosBajos = sma(low, rhithm)
preciosMedios =sma((high+low)/2, rhithm)
preciosAlCierre = sma(close, rhithmBis)

plot(preciosAltos, color=color.rgb(255, 255, 255), title="preciosAltos")
plot(preciosBajos, color=color.rgb(255, 255, 255), title="preciosBajos")
plot(preciosMedios, color=color.rgb(255, 255, 255), title="preciosMedios")
plot(preciosAlCierre, color=color.blue, title = "preciosAlCierre")

comprar = false
cerrar_compra = false
vender = false
cerrar_venta = false
// Gesti贸n del estado de las operaciones
var bool enCompra = false
var bool enVenta = false
var bool busy = enCompra or enVenta

//comprar := close < preciosBajos //and preciosAlCierre < preciosMedios
//cerrar_compra := close > preciosAltos //and preciosAlCierre > preciosMedios
//vender := close > preciosAltos //and preciosAlCierre > preciosMedios
//cerrar_venta := close < preciosBajos //and preciosAlCierre < preciosMedios

comprar := crossover(preciosAlCierre, preciosMedios) and not busy //and preciosAlCierre < preciosMedios
cerrar_compra := crossunder(preciosAlCierre, preciosMedios) and enCompra //and preciosAlCierre > preciosMedios
vender := crossunder(preciosAlCierre, preciosMedios) and not busy //and preciosAlCierre > preciosMedios
cerrar_venta := crossover(preciosAlCierre, preciosMedios) and enVenta //and preciosAlCierre < preciosMedios

var nCompra = 0
var nVenta = 0
var compraName = ""
var ventaName = ""
var success = ""

if (year == 2024 and month == 4 and dayofmonth >= 21 and dayofmonth <= 25)
//if (year == 2024 and month == 4 and dayofmonth >= 1 and dayofmonth <= 3)
//if (year == 2024 and month == 4 and dayofmonth == 7)
//if (true)
    if comprar      
        nCompra := nCompra + 1 
        compraName := "Long-" + tostring(nCompra)
        stopLossPrize = close * (1 - stopLossPercent / 100)
        strategy.entry(compraName, strategy.long)
        // establecer el stop loss en un 1% por debajo de la media m贸vil de precios bajos
        strategy.exit(compraName + "SL", compraName, stop = stopLossPrize)
        //strategy.exit(compraName + "TP", compraName, limit = close*1.01)
        enCompra := true
    if cerrar_compra
        if strategy.grossloss > 0
            success := "Lost"
        else if strategy.grossprofit > 0
            success := "Win"     
        strategy.close(compraName) 
        enCompra := false          
    if vender
        nVenta := nVenta + 1
        ventaName := "Short-" + tostring(nVenta)
        stopLossPrize = close * (1 + stopLossPercent / 100)
        strategy.entry(ventaName, strategy.short)
        strategy.exit(ventaName + "SL", ventaName, stop = stopLossPrize)
       //strategy.exit(ventaName + "TP", ventaName, limit=close*0.99)
        enVenta := true
    if cerrar_venta
        if strategy.grossloss > 0
            success := "Lost"
        else if strategy.grossprofit > 0
            success := "Win"  
        strategy.close(ventaName)
        enVenta := false

busy := enCompra or enVenta
