//@version=4
strategy(title="Jumping sparrow",
         shorttitle="Estrategia de medias móviles", overlay = true, pyramiding = 0, 
         calc_on_order_fills = false, commission_type =  strategy.commission.percent, 
         commission_value = 0, default_qty_type = strategy.percent_of_equity, default_qty_value = 1000, 
         initial_capital=1000, currency=currency.EUR)

rhithm = 5
stopLossPercent = input(0.5, title="Porcentaje del Stop Loss (%)")

// Definir las medias móviles
preciosAltos = sma(high, rhithm)
preciosBajos = sma(low, rhithm)
preciosMedios =sma((high+low)/2, rhithm)
preciosAlCierre = sma(close, rhithm)

plot(preciosAltos, color=color.rgb(255, 255, 255), title="preciosAltos")
plot(preciosBajos, color=color.rgb(255, 255, 255), title="preciosBajos")
plot(preciosMedios, color=color.rgb(255, 255, 255), title="preciosMedios")
plot(preciosAlCierre, color=color.blue, title = "preciosAlCierre")

comprar = false
cerrar_compra = false
vender = false
cerrar_venta = false

comprar := close < preciosBajos and preciosAlCierre < preciosMedios
cerrar_compra := close > preciosAltos //and preciosAlCierre > preciosMedios
vender := close > preciosAltos and preciosAlCierre > preciosMedios
cerrar_venta := close < preciosBajos //and preciosAlCierre < preciosMedios

//comprar := preciosAlCierre < preciosMedios
//cerrar_compra := preciosAlCierre > preciosMedios
//vender := preciosAlCierre > preciosMedios
//cerrar_venta := preciosAlCierre < preciosMedios

var nCompra = 0
var nVenta = 0
var compraName = ""
var ventaName = ""

if (year == 2024 and month == 4 and dayofmonth >= 1 and dayofmonth <= 7)
//if (year == 2024 and month == 4 and dayofmonth >= 1 and dayofmonth <= 3)
//if (year == 2024 and month == 3 and dayofmonth == 28)
//if (true)
    if comprar      
        nCompra := nCompra + 1 
        compraName := "Compra" + tostring(nCompra)
        stopLossPrize = close * (1 - stopLossPercent / 100)
        strategy.entry(compraName, strategy.long)
        // establecer el stop loss en un 1% por debajo de la media móvil de precios bajos
        strategy.exit(compraName + "SL", compraName, stop = stopLossPrize)
        //strategy.exit(compraName + "TP", compraName, limit = close*1.01)
    if cerrar_compra     
        strategy.close(compraName + "Closed")            
    if vender
        nVenta := nVenta + 1
        ventaName := "Venta" + tostring(nVenta)
        stopLossPrize = close * (1 + stopLossPercent / 100)
        strategy.entry(ventaName, strategy.short)
        strategy.exit(ventaName + "SL", ventaName, stop = stopLossPrize)
       //strategy.exit(ventaName + "TP", ventaName, limit=close*0.99)
    if cerrar_venta
        strategy.close(ventaName + "Closed")
