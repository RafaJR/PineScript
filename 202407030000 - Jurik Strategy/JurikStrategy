//@version=4
strategy(title="JurikHull",
         shorttitle="Estrategia de medias móviles de Jurik y Hull combinadas", overlay = true, pyramiding = 0, 
         calc_on_order_fills = false, commission_type =  strategy.commission.percent, 
         commission_value = 0.1, default_qty_type = strategy.percent_of_equity, default_qty_value = 100, 
         initial_capital=100, currency=currency.EUR)
stopLossPercent = input(0.1, title="Porcentaje del Stop Loss (%)")

// Jurik Moving Averange
length = input(title="Length", type=input.integer, defval=7)
phase = input(title="Phase", type=input.integer, defval=50)
power = input(title="Power", type=input.integer, defval=2)
src = input(title="Source", type=input.source, defval=close)
highlightMovements = input(title="Highlight Movements ?", type=input.bool, defval=true)

phaseRatio = phase < -100 ? 0.5 : phase > 100 ? 2.5 : phase / 100 + 1.5

beta = 0.45 * (length - 1) / (0.45 * (length - 1) + 2)
alpha = pow(beta, power)

var float jma = na

var float e0 = na
e0 := (1 - alpha) * src + alpha * nz(e0[1])

var float e1 = na
e1 := (src - e0) * (1 - beta) + beta * nz(e1[1])

var float e2 = na
e2 := (e0 + phaseRatio * e1 - nz(jma[1])) * pow(1 - alpha, 2) + pow(alpha, 2) * nz(e2[1])

jma := e2 + nz(jma[1])

var bool jmaIsLong = false
var bool jmaIsShort = false
jmaColor = color.white

if highlightMovements
    if jma > jma[1]
        jmaColor := color.green
        jmaIsLong := true
        jmaIsShort := false
    else
        jmaColor := color.red
        jmaIsShort := true
        jmaIsLong := false
else
    jmaColor := color.purple
    jmaIsLong := false
    jmaIsShort := false

//jmaColor := highlightMovements ? (jma > jma[1] ? color.green : color.red) : color.purple
plot(jma, title="JMA", linewidth=2, color=color.new(jmaColor, 0))

comprar = false
cerrar_compra = false
vender = false
cerrar_venta = false
// Gestión del estado de las operaciones
var bool enCompra = false
var bool enVenta = false

comprar := jmaIsLong and not enCompra
cerrar_compra := jmaIsShort and enCompra
vender := jmaIsShort and not enVenta
cerrar_venta := jmaIsLong and enVenta

var nCompra = 0
var nVenta = 0
var compraName = ""
var ventaName = ""

if (year == 2024 and month == 5 and dayofmonth >= 20 and dayofmonth <= 22)
//if (year == 2024 and month == 4 and dayofmonth >= 1 and dayofmonth <= 3)
//if (year == 2024 and month == 5)
//if (year == 2024)
//if (true)
    if comprar      
        nCompra := nCompra + 1 
        compraName := "Compra" + tostring(nCompra)
        stopLossPrize = close * (1 - stopLossPercent / 100)
        strategy.entry(compraName, strategy.long)
        // establecer el stop loss en un 1% por debajo de la media móvil de precios bajos
        strategy.exit(compraName + "SL", compraName, stop = stopLossPrize)
        //strategy.exit(compraName + "TP", compraName, limit = close*1.01)
        enCompra := true
        enVenta := false
    if cerrar_compra     
        strategy.close(compraName + "Closed")
        enCompra := false
    if vender
        nVenta := nVenta + 1
        ventaName := "Venta" + tostring(nVenta)
        stopLossPrize = close * (1 + stopLossPercent / 100)
        strategy.entry(ventaName, strategy.short)
        strategy.exit(ventaName + "SL", ventaName, stop = stopLossPrize)
       //strategy.exit(ventaName + "TP", ventaName, limit=close*0.99)
        enVenta := true
        enCompra := false
    if cerrar_venta
        strategy.close(ventaName + "Closed")
        enVenta := false
